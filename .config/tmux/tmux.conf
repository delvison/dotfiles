# =============================================================================
# TMUX CONFIGURATION FILE
# =============================================================================
# Location: ~/.config/tmux/tmux.conf
# Reload: prefix + R (or: tmux source-file ~/.config/tmux/tmux.conf)
#
# This config provides:
# - Vim-style key bindings for navigation
# - X11 and Wayland clipboard support (auto-detected)
# - Mouse support
# - Custom status bar styling
# - TPM plugin management
# =============================================================================


# =============================================================================
# GENERAL SETTINGS
# =============================================================================

# Set terminal type for 256 color support
set -g default-terminal "tmux-256color"
set -ga terminal-overrides ',xterm*:Tc'

# Enable mouse support (scrolling, selecting, resizing panes)
set -g mouse on

# Automatically renumber windows when one is closed
set -g renumber-windows on

# Set custom terminal window/tab titles
set -g set-titles-string "#T : #h > #S > #W"

# Increase scrollback buffer size (262144 lines = 256K)
set -g history-limit 262144

# Start window and pane numbering at 1 instead of 0 (easier to reach)
set -g base-index 1
set -g pane-base-index 1

# Remove escape key delay (0ms) for faster Vim response
set -s escape-time 0

# Enable focus events for applications that need them (e.g., Vim)
set -g focus-events on

# Automatically rename windows based on current process
set -w -g automatic-rename on

# Disable search wrapping (stop at top/bottom)
set -w -g wrap-search off

# Style for window bell notifications (red: #E67E80 -> colour174)
set -g window-status-bell-style fg=colour174,bold,underscore


# =============================================================================
# PREFIX KEY CONFIGURATION
# =============================================================================
# Default prefix is Ctrl+b, changed to Ctrl+a (like GNU screen)

# Unbind default prefix
unbind-key C-b
unbind C-b

# Set new prefix to Ctrl+a
set -g prefix C-a
set-option -g prefix C-a

# Allow sending Ctrl+a to applications (press Ctrl+a twice)
bind-key C-a send-prefix

# Alternative prefix with backtick
bind ` send-prefix

# Reload config with prefix + R
bind R source-file ~/.config/tmux/tmux.conf \; display-message "Config reloaded..."


# =============================================================================
# NAVIGATION KEY BINDINGS (Vim-style)
# =============================================================================

# Pane navigation with h/j/k/l (like Vim)
unbind h
bind -r h select-pane -L      # Move left
unbind j
bind -r j select-pane -D      # Move down
unbind k
bind -r k select-pane -U      # Move up
unbind l
bind -r l select-pane -R      # Move right (was: last-window)

# Pane resizing with arrow keys (repeat with -r flag)
unbind Left
bind -r Left resize-pane -L 5   # Shrink width
unbind Right
bind -r Right resize-pane -R 5  # Grow width
unbind Down
bind -r Down resize-pane -D 5   # Shrink height
unbind Up
bind -r Up resize-pane -U 5     # Grow height

# (Disabled) Fast toggle to last window with prefix + space
# bind ^space last-window


# =============================================================================
# WINDOW AND PANE SPLITTING
# =============================================================================

# Horizontal split with | or \
# Opens in current directory
bind | split-window -h -c '#{pane_current_path}'
bind \\ split-window -h -c '#{pane_current_path}'

# Vertical split with -
bind - split-window -v -c '#{pane_current_path}'

# Full window splits (tmux 2.3+)
bind-key | split-window -fh -c '#{pane_current_path}'  # Full horizontal
bind-key _ split-window -fv -c '#{pane_current_path}'  # Full vertical

# Create split at column 80 (useful for coding)
bind-key a split-window -h -l 80
set -w -g main-pane-width 85


# =============================================================================
# COPY AND PASTE (X11 and Wayland Support)
# =============================================================================
# Auto-detects display server and uses appropriate clipboard tool:
# - Wayland: wl-copy (from wl-clipboard package)
# - X11: xclip

# Mouse drag to copy
bind-key -T copy-mode MouseDragEnd1Pane send-keys -X copy-pipe "sh -c 'if [ \"$XDG_SESSION_TYPE\" = \"wayland\" ]; then wl-copy; else xclip -selection clipboard -i -silent; fi'" \; display-message "Copied!"

# 'y' key to copy in copy mode
bind-key -T copy-mode y send-keys -X copy-pipe "sh -c 'if [ \"$XDG_SESSION_TYPE\" = \"wayland\" ]; then wl-copy; else xclip -in -selection clipboard -i -silent; fi'" \; display-message "Copied!"

# (Disabled) macOS copy commands - uncomment if on Mac
# bind-key -T copy-mode-vi MouseDragEnd1Pane send-keys -X copy-pipe "pbcopy"
# bind-key -T copy-mode-vi y send-keys -X copy-pipe "pbcopy"

# Paste buffer with prefix + P
bind P paste-buffer


# =============================================================================
# MOUSE SCROLLING BEHAVIOR
# =============================================================================

# Scroll up with mouse wheel - enter copy mode if not already in it
bind-key -T root WheelUpPane \
  if-shell -Ft= '#{?pane_in_mode,1,#{mouse_any_flag}}' \
    'send -Mt=' \
    'if-shell -Ft= "#{alternate_on}" "send -t= Up" "copy-mode -et="'

# Scroll down with mouse wheel
bind-key -T root WheelDownPane \
  if-shell -Ft = '#{?pane_in_mode,1,#{mouse_any_flag}}' \
    'send -Mt=' \
    'if-shell -Ft= "#{alternate_on}"  "send -t= Down" "send -Mt="'


# =============================================================================
# STATUS BAR DESIGN
# =============================================================================

# Position status bar at the top
set -g status-position top

# Status bar colors and style - Everforest Dark Medium
# bg0: #2D353B (colour236), fg: #D3C6AA (colour250)
set -g status-style bg=colour236,fg=colour250
set -g status-justify left
set -g status-interval 30
set -g status-left ''

# Status bar right side: custom script + time
# green: #A7C080 (colour107)
set -g status-right '#( ~/.config/scripts/tmux_right_status.sh ) #[fg=colour107] %H:%M:%S'

# Window status format
setw -g window-status-format " #F#I:#W#F "
setw -g window-status-current-format " #F#I:#W#F "

# Active window styling
# bg2: #3D484D (colour237), green: #A7C080 (colour107)
set -w -g window-status-current-style 'fg=colour107 bg=colour237'
setw -g window-status-current-format " #F#I:#W#F "

# Message/command line styling
# bg0: #2D353B (colour236), green: #A7C080 (colour107)
set -g message-style 'fg=colour250 bg=colour235'
set -g message-command-style 'fg=colour250 bg=colour237'

# Window mode (copy mode) styling
# bg2: #3D484D (colour237), fg: #D3C6AA (colour250)
setw -g mode-style 'fg=colour250 bg=colour237'


# =============================================================================
# PANE BORDERS
# =============================================================================

# Inactive pane borders
# bg3: #475258 (colour238)
set -g pane-border-style 'fg=colour238'

# Active pane borders (aqua: #83C092 -> colour72)
set -g pane-active-border-style 'fg=colour72'


# =============================================================================
# CUSTOM TOGGLES AND SCRIPTS
# =============================================================================

# Meta+t toggle in copy mode (runs custom script)
bind-key -T copy-mode M-t run-shell "~/.config/tmux/tools/linkarzu/simple_toggle.sh"
bind-key -T copy-mode-vi M-t run-shell "~/.config/tmux/tools/linkarzu/simple_toggle.sh"


# =============================================================================
# TPM PLUGIN MANAGEMENT
# =============================================================================
# Requires TPM (Tmux Plugin Manager)
# Install: git clone https://github.com/tmux-plugins/tpm ~/.config/tmux/plugins/tpm
# Install plugins: prefix + I
# Update plugins: prefix + U

# List of plugins
set -g @plugin 'tmux-plugins/tpm'              # Plugin manager
set -g @plugin 'tmux-plugins/tmux-sensible'    # Sensible defaults
set -g @plugin 'tmux-plugins/tmux-open'        # Open URLs/files
set -g @plugin 'bobcats/everforest-tmux'       # Color scheme
set -g @plugin 'tmux-plugins/tmux-yank'        # Better copy/paste

# tmux-yank configuration
set -g @yank_selection_mouse 'clipboard'
set -g @override_copy_command "sh -c 'if [ \"\$XDG_SESSION_TYPE\" = \"wayland\" ]; then wl-copy; else xclip -selection clipboard -i -silent; fi'"

# Initialize TPM (must be at the bottom)
run '~/.config/tmux/plugins/tpm'
